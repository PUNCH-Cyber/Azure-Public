{
    "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
    "handler": "Microsoft.Azure.CreateUIDef",
    "version": "0.1.2-preview",
    "parameters": {
        "config": {
            "isWizard": true,
            "basics": {
                "description": "**Providence Secure Master Onboarding Template**\n\n**Description:** \nThis template is used to onboard new customers to the Providence Secure Managed Security Services platform and will guide engineers through the process. note that some section of this deployment may change as new connectors and integration are built to be supported by Providence Secure. To get started, complete the for on this page and click the next button at the bottom.\n\n**IMPORTANT:** \nThe first resource group needs to follow this naming convention, Customers name with no spaces followed by '-Sentinel'Â  (e.g. CustomerName-Sentinel)\nThe Customer Name field should follow the naming convention, Customers name with no spaces.",
				"location": {
                    "label": "Location",
                    "toolTip": "Location for all resources",
                    "resourceTypes": [
                        "Microsoft.OperationalInsights"
                    ]
                }
				
            }
        },
        "basics": [
            {
                "name": "customerName",
                "type": "Microsoft.Common.TextBox",
                "label": "Customer Name",
                "placeholder": "",
                "defaultValue": "",
                "toolTip": "The Customer name should include 4-63 letters, digits or '-'. The '-' shouldn't be the first or the last symbol.",
                "constraints": {
                    "required": true,
                    "regex": "^[A-Za-z0-9]{1,30}$",
                    "validationMessage": "Only alphanumeric characters are allowed, and the value must be 1-30 characters long."
                },
                "visible": true
            },
            {
                "name": "dailyQuota",
                "type": "Microsoft.Common.TextBox",
                "label": "Daily ingestion limit in GBs. Enter 0 for no limit.",
                "placeholder": "",
                "defaultValue": "0",
                "toolTip": "This limit doesn't apply to the following tables: SecurityAlert, SecurityBaseline, SecurityBaselineSummary, SecurityDetection, SecurityEvent, WindowsFirewall, MaliciousIPCommunication, LinuxAuditLog, SysmonEvent, ProtectionStatus, WindowsEvent",
                "constraints": {
                    "required": true,
                    "regex": "^[0-9]{1,4}$",
                    "validationMessage": "Only numbers allowed, and the value must be 1-4 characters long."
                },
                "visible": true
            },
            {
                "name": "dataRetention",
                "type": "Microsoft.Common.TextBox",
                "label": "Number of days of retention",
                "placeholder": "",
                "defaultValue": "90",
                "toolTip": "Only numbers allowed",
                "constraints": {
                    "required": true,
                    "regex": "([3-8][0-9]|9[0-9]|[1-6][0-9]{2}|7[0-2][0-9]|730)",
                    "validationMessage": "Retention must be between 30 and 730 days."
                },
                "visible": true
            }
        ],
        "steps": [
            {
                "name": "dataConnectors",
                "label": "Data connectors",
                "elements": [
                    {
                        "name": "textBlock1",
                        "type": "Microsoft.Common.TextBlock",
                        "visible": true,
                        "options": {
                            "text": "Please select which connectors you want to onboard into your Azure Sentinel environment",
                            "link": {
                                "label": "Learn more",
                                "uri": "https://www.microsoft.com"
                            }
                        }
                    },
                    {
                        "name": "enableDataConnectorsKind",
                        "type": "Microsoft.Common.DropDown",
                        "label": "Select data connectors to onboard",
                        "placeholder": "",
                        "multiselect": true,
                        "defaultValue": "AzureSecurityCenter",
                        "toolTip": "Select the data connectors that you would like to enable",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "Office365",
                                    "value": "Office365"
                                },
                                {
                                    "label": "Azure ATP",
                                    "value": "AzureAdvancedThreatProtection"
                                },
                                {
                                    "label": "Azure AD Identity Protection",
                                    "value": "AzureActiveDirectory"
                                },
                                {
                                    "label": "Microsoft Defender ATP",
                                    "value": "MicrosoftDefenderAdvancedThreatProtection"
                                },
                                {
                                    "label": "Azure Security Center",
                                    "value": "AzureSecurityCenter"
                                },
                                {
                                    "label": "Microsoft Cloud App Security",
                                    "value": "MicrosoftCloudAppSecurity"
                                },
                                {
                                    "label": "Azure Activity",
                                    "value": "AzureActivity"
                                },
                                {
                                    "label": "Security Events",
                                    "value": "SecurityEvents"
                                },
                                {
                                    "label": "Windows Firewall",
                                    "value": "WindowsFirewall"
                                },
                                {
                                    "label": "DNS Analytics",
                                    "value": "DNS"
                                },
                                {
                                    "label": "Linux Syslog",
                                    "value": "Syslog"
                                }
                            ],
                            "required": false
                        },
                        "visible": true
                    },
                    {
                        "name": "mcasDiscoveryLogs",
                        "type": "Microsoft.Common.CheckBox",
                        "label": "Enable MCAS Discovery Logs?",
                        "toolTip": "Select to bring MCAS discovery logs into Sentinel. These logs are billed.",
                        "constraints": {
                            "required": false,
                            "validationMessage": "Please select"
                        },
                        "visible": "[if(contains(steps('dataConnectors').enableDataConnectorsKind,'MicrosoftCloudAppSecurity'), true, false)]"
                    },
                    {
                        "name": "securityCollectionTier",
                        "type": "Microsoft.Common.OptionsGroup",
                        "label": "Security Events to stream into Sentinel ",
                        "defaultValue": "Recommended",
                        "toolTip": "",
                        "constraints": {
                            "allowedValues": [
                                {
                                    "label": "All",
                                    "value": "All"
                                },
                                {
                                    "label": "Common",
                                    "value": "Recommended"
                                },
                                {
                                    "label": "Minimal",
                                    "value": "Minimal"
                                }
                            ],
                            "required": true
                        },
                        "visible": "[if(contains(steps('dataConnectors').enableDataConnectorsKind,'SecurityEvents'), true, false)]"
                    }
                ]
            },
			{
                "name": "thirdParty",
                "label": "Log Collectors",
                "elements": [
                    {
                        "name": "textBlock2",
                        "type": "Microsoft.Common.TextBlock",
                        "visible": true,
                        "options": {
                            "text": "Please select which additional connectors you want to onboard into your Azure Sentinel environment."
                        }
                    },
					{
                        "name": "enableSyslogDeployment",
                        "type": "Microsoft.Common.CheckBox",
                        "label": "Deploy Syslog/CEF log collector?",
                        "toolTip": "This will deploy a Virtual Machine Scaling Set to collect logs and stream them into Senitnel",
                        "constraints": {
                            "required": false,
                            "validationMessage": "Please select"
                        },
                        "visible": true
                    },
                    {
                        "name": "enableQualysDeployment",
                        "type": "Microsoft.Common.CheckBox",
                        "label": "Deploy QualysVM log collector?",
                        "toolTip": "Select to enable the deployment of the QualysVM log collection.",
                        "constraints": {
                            "required": false,
                            "validationMessage": "Enables Qualys Vulnerability Management platform."
                        },
                        "visible": true
                    },
                    {
                        "name": "enableCSDeployment",
                        "type": "Microsoft.Common.CheckBox",
                        "label": "Deploy CrowdStrikeEDR log collector?",
                        "toolTip": "This will deploy a single VM to collect streaming events from the CrowdStrike platform.",
                        "constraints": {
                            "required": false,
                            "validationMessage": "Enables CrowdStrike platform"
                        },
                        "visible": true
                    },
					{
                        "name": "textBlock3",
                        "type": "Microsoft.Common.TextBlock",
                        "visible": "[if(or(steps('thirdParty').enableSyslogDeployment,steps('thirdParty').enableCSDeployment), true, false)]",
                        "options": {
                            "text": "Virtual Machine deployment information:"
                        }
                    },
                    {
                        "name": "VMAdminUserName",
                        "type": "Microsoft.Compute.UserNameTextBox",
                        "label": "VM Admin UserName",
                        "defaultValue": "",
						"osPlatform": "Linux",
                        "constraints": {
                            "required": false,
                            "regex": "^[a-z0-9A-Z-]{1,30}$",
                            "validationMessage": "Only alphanumeric characters are allowed, and the value must be 1-30 characters long."
                        },
                        "toolTip": "This is the Username for the VM(SS) deployment",
                        "visible": "[if(or(steps('thirdParty').enableSyslogDeployment,steps('thirdParty').enableCSDeployment), true, false)]"
                    },
                    {
                        "name": "VMAdminPassword",
                        "type": "Microsoft.Common.PasswordBox",
                        "label": {
                            "password": "VM Admin Password",
                            "confirmPassword": "Confirm password"
                        },
                        "constraints": {
                            "required": false,
                            "regex": "^[a-zA-Z0-9!@#$%&]{11,40}$",
                            "validationMessage": "Password must be at least 8 - 40 characters long, contain only numbers, letters and special characters"
                        },
                        "toolTip": "This is the Password for the VM(SS) deployment",
                        "visible": "[if(or(steps('thirdParty').enableSyslogDeployment,steps('thirdParty').enableCSDeployment), true, false)]"
                    },
					{
                        "name": "textBlock4",
                        "type": "Microsoft.Common.TextBlock",
                        "visible": "[if(steps('thirdParty').enableCSDeployment, true, false)]",
                        "options": {
                            "text": "CrowdStrike deployment information:"
                        }
                    },
                    {
                        "name": "crowdstrikeClientID",
                        "type": "Microsoft.Common.TextBox",
                        "label": "CrowdStrike API Client ID",
                        "placeholder": "",
                        "defaultValue": "",
                        "toolTip": "This is from the CS 'API and Integrations' menu within CS.",
                        "constraints": {
                            "required": false,
                            "regex": "^[A-Za-z0-9][A-Za-z0-9-]+[A-Za-z0-9]$",
                            "validationMessage": "Only alphanumeric characters are allowed, and the value must be 1-30 characters long."
                        },
                        "visible": "[if(steps('thirdParty').enableCSDeployment, true, false)]"
                    },
                    {
                        "name": "crowdstrikeClientKey",
                        "type": "Microsoft.Common.TextBox",
                        "label": "CrowdStrike API Client Key",
                        "placeholder": "",
                        "defaultValue": "",
                        "toolTip": "This is the password for the Qualys account",
                        "constraints": {
                            "required": false,
                            "regex": "^[A-Za-z0-9][A-Za-z0-9-]+[A-Za-z0-9]$",
                            "validationMessage": "Only alphanumeric characters are allowed, and the value must be 1-30 characters long."
                        },
                        "visible": "[if(steps('thirdParty').enableCSDeployment, true, false)]"
                    },
					{
                        "name": "textBlock5",
                        "type": "Microsoft.Common.TextBlock",
                        "visible": "[if(steps('thirdParty').enableQualysDeployment, true, false)]",
                        "options": {
                            "text": "Qualys deployment information:"
                        }
                    },
                    {
                        "name": "qualysUser",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Qualys Username (API access enabled)",
                        "placeholder": "",
                        "defaultValue": "",
                        "toolTip": "This account username must be granted access to the API platform to work",
                        "constraints": {
                            "required": false,
                            "regex": "^[A-Za-z0-9][A-Za-z0-9-]+[A-Za-z0-9]$",
                            "validationMessage": "Only alphanumeric characters are allowed, and the value must be 1-30 characters long."
                        },
                        "visible": "[if(steps('thirdParty').enableQualysDeployment, true, false)]"
                    },
                    {
                        "name": "qualysPass",
                        "type": "Microsoft.Common.TextBox",
                        "label": "Qualys Password",
                        "placeholder": "",
                        "defaultValue": "",
                        "toolTip": "This is the password for the Qualys account",
                        "visible": "[if(steps('thirdParty').enableQualysDeployment, true, false)]"
                    }
				]
			},
            {
                "name": "analyticsRules",
                "label": "Analytics Rules",
                "elements": [
                    {
                        "name": "enableFusionAlert",
                        "type": "Microsoft.Common.CheckBox",
                        "label": "Enable Fusion alert rule?",
                        "toolTip": "Select to enable Fusion analyttic rule. Details here: https://docs.microsoft.com/azure/sentinel/fusion",
                        "constraints": {
                            "required": false,
                            "validationMessage": "Please select"
                        },
                        "visible": true
                    },
                    {
                        "name": "enableMicrosoftAlerts",
                        "type": "Microsoft.Common.CheckBox",
                        "label": "Enable Microsoft alert rules for selected connectors?",
                        "toolTip": "Select to enable Microsoft rules for the connectors you selected in the previous step.",
                        "constraints": {
                            "required": false,
                            "validationMessage": "Enables rules coming from selected Microsoft security products"
                        },
                        "visible": "[if(or(contains(steps('dataConnectors').enableDataConnectorsKind,'AzureAdvancedThreatProtection'),contains(steps('dataConnectors').enableDataConnectorsKind,'AzureActiveDirectoryIdentityProtection'),contains(steps('dataConnectors').enableDataConnectorsKind,'MicrosoftDefenderAdvancedThreatProtection'),contains(steps('dataConnectors').enableDataConnectorsKind,'AzureSecurityCenter'),contains(steps('dataConnectors').enableDataConnectorsKind,'MicrosoftCloudAppSecurity')), true, false)]"
                    },
                    {
                        "name": "enableMLAlerts",
                        "type": "Microsoft.Common.CheckBox",
                        "label": "Enable ML Behavior Analytics alert rules?",
                        "toolTip": "Select to enable ML Behavior Analytics rules for selected connectors (SecurityEvents and/or Syslog)",
                        "constraints": {
                            "required": false,
                            "validationMessage": "Enables SSH and/or RDP anomalous login alerts"
                        },
                        "visible": "[if(or(contains(steps('dataConnectors').enableDataConnectorsKind,'Syslog'),contains(steps('dataConnectors').enableDataConnectorsKind,'SecurityEvents')), true, false)]"
                    },
                    {
                        "name": "enableScheduledAlerts",
                        "type": "Microsoft.Common.CheckBox",
                        "label": "Enable Scheduled alert rules for selected connectors?",
                        "toolTip": "Select to enable scheduled analytics rules for selected connectors",
                        "constraints": {
                            "required": false,
                            "validationMessage": "Enables Scheduled rules matching any of the selected connectors"
                        },
                        "visible": true
                    }
                ]
            }
        ],
        "outputs": {
            "customerName": "[basics('customerName')]",
            "dailyQuota": "[basics('dailyQuota')]",
            "dataRetention": "[basics('dataRetention')]",
            "enableDataConnectorsKind": "[steps('dataConnectors').enableDataConnectorsKind]",
            "securityCollectionTier": "[steps('dataConnectors').securityCollectionTier]",
            "mcasDiscoveryLogs": "[steps('dataConnectors').mcasDiscoveryLogs]",
            "location": "[location()]",
            "enableSyslog": "[steps('thirdParty').enableSyslogDeployment]",
            "enableQualysDeployment": "[steps('thirdParty').enableQualysDeployment]",
            "enableCSDeployment": "[steps('thirdParty').enableCSDeployment]",
            "VMAdminUserName": "[steps('thirdParty').VMAdminUserName]",
            "VMAdminPassword": "[steps('thirdParty').VMAdminPassword]",
            "qualysUser": "[steps('thirdParty').qualysUser]",
            "qualysPass": "[steps('thirdParty').qualysPass]",
            "CSAPIID": "[steps('thirdParty').crowdstrikeClientID]",
            "CSAPIKEY": "[steps('thirdParty').crowdstrikeClientKey]",
            "enableFusionAlert": "[steps('analyticsRules').enableFusionAlert]",
            "enableMicrosoftAlerts": "[steps('analyticsRules').enableMicrosoftAlerts]",
            "enableMLAlerts": "[steps('analyticsRules').enableMLAlerts]", 
            "enableScheduledAlerts": "[steps('analyticsRules').enableScheduledAlerts]"
        }
    }
}
